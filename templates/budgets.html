{% extends "base.html" %}

{% block title %}Budgets - MoneyWise{% endblock %}

{% block content %}
<div class="budgets-page">
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1><i class="fas fa-chart-pie"></i> Budgets</h1>
            <p>{{ month_name }} {{ year }}</p>
        </div>
        
        <!-- Budget Cards -->
        {% if budgets %}
        <div class="budgets-grid">
            {% for budget in budgets %}
            <div class="budget-card">
                <div class="budget-header">
                    <div class="budget-category">
                        <span class="category-icon" style="background-color: {{ budget.category.color }}20;">
                            {{ budget.category.icon }}
                        </span>
                        <h3>{{ budget.category.name }}</h3>
                    </div>
                    <div class="budget-amount">
                        <p class="spent">₹{{ "%.2f"|format(budget.get_spent_amount()) }}</p>
                        <p class="total">of ₹{{ "%.2f"|format(budget.amount) }}</p>
                    </div>
                </div>
                
                <div class="budget-progress">
                    <div class="progress-bar">
                        <div class="progress-fill {{ budget.get_status() }}" 
                             style="width: {{[budget.get_percentage_used(), 100]|min}}%">
                        </div>
                    </div>
                    <div class="progress-info">
                        <span class="percentage">{{ "%.1f"|format(budget.get_percentage_used()) }}%</span>
                        <span class="remaining">₹{{ "%.2f"|format(budget.get_remaining()) }} left</span>
                    </div>
                </div>
                
                <div class="budget-status">
                    {% set status = budget.get_status() %}
                    {% if status == 'exceeded' %}
                        <span class="status-badge exceeded">
                            <i class="fas fa-exclamation-triangle"></i> Over Budget
                        </span>
                    {% elif status == 'alert' %}
                        <span class="status-badge alert">
                            <i class="fas fa-exclamation-circle"></i> 90% Used
                        </span>
                    {% elif status == 'warning' %}
                        <span class="status-badge warning">
                            <i class="fas fa-info-circle"></i> {{ budget.alert_threshold }}% Used
                        </span>
                    {% else %}
                        <span class="status-badge on-track">
                            <i class="fas fa-check-circle"></i> On Track
                        </span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="card">
            <div class="card-body">
                <div class="empty-state">
                    <i class="fas fa-chart-pie"></i>
                    <h3>No Budgets Set</h3>
                    <p>Set budgets for your expense categories to stay on track</p>
                    <button class="btn btn-primary" onclick="openSetBudgetModal()">
                        <i class="fas fa-plus"></i> Set Your First Budget
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Add Budget Button -->
        {% if budgets %}
        <div class="add-budget-section">
            <button class="btn btn-primary btn-lg" onclick="openSetBudgetModal()">
                <i class="fas fa-plus"></i> Add Budget
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Set Budget Modal -->
<div id="budgetModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-chart-pie"></i> Set Budget</h2>
            <button class="close-modal" onclick="closeBudgetModal()">&times;</button>
        </div>
        
        <form method="POST" action="{{ url_for('budgets') }}">
            <div class="modal-body">
                <div class="form-group">
                    <label for="category">Category *</label>
                    <select id="category" name="category_id" class="form-control" required>
                        <option value="">Select a category</option>
                        {% for category in categories %}
                        <option value="{{ category.id }}">
                            {{ category.icon }} {{ category.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="budget_amount">Budget Amount *</label>
                    <input 
                        type="number" 
                        id="budget_amount" 
                        name="amount" 
                        class="form-control" 
                        step="0.01" 
                        min="0.01" 
                        required 
                        placeholder="0.00"
                    >
                </div>
                
                <div class="form-group">
                    <label for="alert_threshold">Alert Threshold (%)</label>
                    <input 
                        type="number" 
                        id="alert_threshold" 
                        name="alert_threshold" 
                        class="form-control" 
                        value="80" 
                        min="1" 
                        max="100"
                    >
                    <small class="form-text">Get notified when you reach this percentage</small>
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeBudgetModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Set Budget
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function openSetBudgetModal() {
        document.getElementById('budgetModal').style.display = 'flex';
    }
    
    function closeBudgetModal() {
        document.getElementById('budgetModal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
        const modal = document.getElementById('budgetModal');
        if (event.target === modal) {
            closeBudgetModal();
        }
    }
</script>
{% endblock %}